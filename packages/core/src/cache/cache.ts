import { GraphQLSchema } from 'graphql';
import LRU from 'lru-cache';
import { createHash } from 'node:crypto';
import { LoadedFlatbreadConfig } from '../types';
import { anyToString } from '../utils/stringUtils';

type SchemaCacheKey = string;

interface FlatbreadCache {
  schema: LRU<SchemaCacheKey, GraphQLSchema>;
}

/**
 * A general cache for computationally heavy operations in Flatbread.
 */
export const cache: FlatbreadCache = {
  /**
   * An LRU cache for GraphQL schemas generated by Flatbread.
   */
  schema: new LRU({
    max: 100,
  }),
};

/**
 * Setter function for caching the GraphQL schema generated by Flatbread.
 */
export function cacheSchema(
  config: LoadedFlatbreadConfig,
  schema: GraphQLSchema
) {
  const schemaHashKey = getSchemaHash(config);
  cache.schema.set(schemaHashKey, schema);
}

/**
 * Getter function for retrieving the GraphQL schema generated by Flatbread for a given config.
 */
export function checkCacheForSchema(
  config: LoadedFlatbreadConfig
): GraphQLSchema | undefined {
  const schemaHashKey = getSchemaHash(config);
  return cache.schema.get(schemaHashKey);
}

/**
 * Generates a hash key for a given Flatbread config.
 *
 * TODO: handle field changes in content nodes (e.g. changing a field from a string to an int)
 */
export function getSchemaHash(config: LoadedFlatbreadConfig) {
  return createHash('md5').update(anyToString(config)).digest('hex');
}
